# üîó **INTEGRA√á√ÉO META COMPLETA 2024**
## **Guia Definitivo para WhatsApp Business API e Instagram Basic Display**

---

## üìã **√çNDICE**

1. [Configura√ß√£o Inicial do App Meta](#configura√ß√£o-inicial-do-app-meta)
2. [WhatsApp Business API](#whatsapp-business-api)
3. [Instagram Basic Display API](#instagram-basic-display-api)
4. [Configura√ß√£o de Webhooks](#configura√ß√£o-de-webhooks)
5. [Configura√ß√£o do Projeto](#configura√ß√£o-do-projeto)
6. [Vari√°veis de Ambiente](#vari√°veis-de-ambiente)
7. [Testes e Valida√ß√£o](#testes-e-valida√ß√£o)
8. [Publica√ß√£o do App](#publica√ß√£o-do-app)
9. [Troubleshooting](#troubleshooting)

---

## üöÄ **CONFIGURA√á√ÉO INICIAL DO APP META**

### **1. Criar App no Meta for Developers**

1. **Acesse**: https://developers.facebook.com/
2. **Login** com conta Facebook Business
3. **Criar App** ‚Üí **Business** ‚Üí **Continuar**
4. **Preencher**:
   - **Nome do App**: `Connect IA`
   - **Email de contato**: `contato@agenciapixel.digital`
   - **Categoria**: `Business`
   - **Prop√≥sito**: `Gerenciar clientes`

### **2. Configura√ß√µes B√°sicas**

```
App ID: 670209849105494
App Secret: [CONFIGURAR NO AMBIENTE]
```

### **3. Dom√≠nios Configurados**

```
Dom√≠nio do App: connectia.agenciapixel.digital
Dom√≠nio do Site: https://connectia.agenciapixel.digital
Privacy Policy: https://connectia.agenciapixel.digital/terms.html
```

---

## üì± **WHATSAPP BUSINESS API**

### **1. Configura√ß√£o do WhatsApp Business**

#### **A. Adicionar Produto WhatsApp**
1. **App Dashboard** ‚Üí **Produtos** ‚Üí **WhatsApp** ‚Üí **Configurar**
2. **N√∫mero de Telefone**: Configurar n√∫mero de teste ou produ√ß√£o
3. **Webhook**: Configurar URL e token

#### **B. Configura√ß√µes Necess√°rias**

```javascript
// Configura√ß√µes WhatsApp Business API
const whatsappConfig = {
  phoneNumberId: "PHONE_NUMBER_ID", // ID do n√∫mero de telefone
  businessAccountId: "BUSINESS_ACCOUNT_ID", // ID da conta business
  accessToken: "ACCESS_TOKEN", // Token de acesso permanente
  verifyToken: "VERIFY_TOKEN", // Token para verifica√ß√£o webhook
  webhookUrl: "https://connectia.agenciapixel.digital/api/whatsapp-webhook"
};
```

### **2. Estrutura do Webhook WhatsApp**

```typescript
// supabase/functions/whatsapp-webhook/index.ts
interface WhatsAppWebhookData {
  object: string;
  entry: Array<{
    id: string;
    changes: Array<{
      value: {
        messaging_product: string;
        metadata: {
          display_phone_number: string;
          phone_number_id: string;
        };
        messages: Array<{
          id: string;
          from: string;
          timestamp: string;
          text?: {
            body: string;
          };
          type: string;
        }>;
      };
      field: string;
    }>;
  }>;
}
```

### **3. Fluxo de Mensagens WhatsApp**

```mermaid
graph TD
    A[Cliente envia mensagem] --> B[WhatsApp Business API]
    B --> C[Webhook Connect IA]
    C --> D[Supabase Edge Function]
    D --> E[Processar mensagem]
    E --> F[Salvar no banco]
    F --> G[Notificar atendente]
    G --> H[Responder cliente]
```

---

## üì∏ **INSTAGRAM BASIC DISPLAY API**

### **1. Configura√ß√£o do Instagram**

#### **A. Adicionar Produto Instagram**
1. **App Dashboard** ‚Üí **Produtos** ‚Üí **Instagram Basic Display** ‚Üí **Configurar**
2. **OAuth Redirect URIs**: `https://connectia.agenciapixel.digital/auth/instagram/callback`
3. **Deauthorize Callback URL**: `https://connectia.agenciapixel.digital/auth/instagram/deauthorize`

#### **B. Configura√ß√µes OAuth**

```javascript
// Configura√ß√µes Instagram OAuth
const instagramConfig = {
  clientId: "INSTAGRAM_CLIENT_ID",
  clientSecret: "INSTAGRAM_CLIENT_SECRET",
  redirectUri: "https://connectia.agenciapixel.digital/auth/instagram/callback",
  scope: "user_profile,user_media"
};
```

### **2. Fluxo de Autentica√ß√£o Instagram**

```mermaid
graph TD
    A[Usu√°rio clica conectar] --> B[Redirect para Instagram OAuth]
    B --> C[Instagram autoriza]
    C --> D[Callback com code]
    D --> E[Trocar code por access_token]
    E --> F[Salvar credenciais]
    F --> G[Conectar canal]
```

---

## üîó **CONFIGURA√á√ÉO DE WEBHOOKS**

### **1. WhatsApp Webhook**

#### **URL do Webhook**
```
https://connectia.agenciapixel.digital/api/whatsapp-webhook
```

#### **Campos de Assinatura**
- `messages` - Mensagens recebidas
- `message_deliveries` - Status de entrega
- `message_reads` - Status de leitura

#### **Verifica√ß√£o do Webhook**
```typescript
// GET request para verifica√ß√£o
const verifyWebhook = (req: Request) => {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];
  
  if (mode === 'subscribe' && token === VERIFY_TOKEN) {
    return new Response(challenge, { status: 200 });
  }
  return new Response('Forbidden', { status: 403 });
};
```

### **2. Instagram Webhook**

#### **URL do Webhook**
```
https://connectia.agenciapixel.digital/api/instagram-webhook
```

#### **Campos de Assinatura**
- `instagram_messages` - Mensagens recebidas
- `messaging_postbacks` - Callbacks de bot√µes

---

## ‚öôÔ∏è **CONFIGURA√á√ÉO DO PROJETO**

### **1. Estrutura de Arquivos**

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ WhatsAppSetup.tsx          # Configura√ß√£o WhatsApp
‚îÇ   ‚îú‚îÄ‚îÄ InstagramSetup.tsx         # Configura√ß√£o Instagram
‚îÇ   ‚îú‚îÄ‚îÄ MetaOAuthConnect.tsx       # OAuth Meta
‚îÇ   ‚îî‚îÄ‚îÄ WhatsAppQRConnect.tsx      # Conex√£o QR WhatsApp
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ whatsapp.ts               # Fun√ß√µes WhatsApp
‚îÇ   ‚îî‚îÄ‚îÄ instagram.ts              # Fun√ß√µes Instagram
‚îî‚îÄ‚îÄ pages/
    ‚îî‚îÄ‚îÄ Integrations.tsx           # P√°gina de integra√ß√µes

supabase/
‚îî‚îÄ‚îÄ functions/
    ‚îú‚îÄ‚îÄ whatsapp-webhook/         # Webhook WhatsApp
    ‚îú‚îÄ‚îÄ instagram-webhook/        # Webhook Instagram
    ‚îú‚îÄ‚îÄ whatsapp-send-message/    # Enviar mensagem WhatsApp
    ‚îî‚îÄ‚îÄ instagram-send-message/   # Enviar mensagem Instagram
```

### **2. Configura√ß√£o do SDK Meta**

```html
<!-- public/index.html -->
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '670209849105494',
      cookie     : true,
      xfbml      : true,
      version    : 'v19.0' // Vers√£o mais recente
    });
    FB.AppEvents.logPageView();
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/pt_BR/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
```

### **3. Componente de Configura√ß√£o WhatsApp**

```typescript
// src/components/WhatsAppSetup.tsx
interface WhatsAppConfig {
  name: string;
  phoneNumberId: string;
  businessAccountId: string;
  accessToken: string;
  verifyToken: string;
}

export function WhatsAppSetup() {
  const [config, setConfig] = useState<WhatsAppConfig>({
    name: "",
    phoneNumberId: "",
    businessAccountId: "",
    accessToken: "",
    verifyToken: ""
  });

  const handleConnect = async () => {
    try {
      const result = await connectWhatsAppChannel({
        ...config,
        orgId: user.id
      });
      
      toast.success("WhatsApp conectado com sucesso!");
    } catch (error) {
      toast.error("Erro ao conectar WhatsApp");
    }
  };

  return (
    <div className="space-y-4">
      <Input
        placeholder="Nome do canal"
        value={config.name}
        onChange={(e) => setConfig(prev => ({...prev, name: e.target.value}))}
      />
      <Input
        placeholder="Phone Number ID"
        value={config.phoneNumberId}
        onChange={(e) => setConfig(prev => ({...prev, phoneNumberId: e.target.value}))}
      />
      <Input
        placeholder="Business Account ID"
        value={config.businessAccountId}
        onChange={(e) => setConfig(prev => ({...prev, businessAccountId: e.target.value}))}
      />
      <Input
        placeholder="Access Token"
        type="password"
        value={config.accessToken}
        onChange={(e) => setConfig(prev => ({...prev, accessToken: e.target.value}))}
      />
      <Input
        placeholder="Verify Token"
        value={config.verifyToken}
        onChange={(e) => setConfig(prev => ({...prev, verifyToken: e.target.value}))}
      />
      <Button onClick={handleConnect}>
        Conectar WhatsApp
      </Button>
    </div>
  );
}
```

---

## üîê **VARI√ÅVEIS DE AMBIENTE**

### **1. Supabase Edge Functions**

```bash
# WhatsApp Business API
WHATSAPP_ACCESS_TOKEN=EAABwzLixnjYBO...
WHATSAPP_PHONE_NUMBER_ID=123456789012345
WHATSAPP_BUSINESS_ACCOUNT_ID=123456789012345
WHATSAPP_VERIFY_TOKEN=meu_token_verificacao

# Instagram Basic Display
INSTAGRAM_CLIENT_ID=1234567890123456
INSTAGRAM_CLIENT_SECRET=abc123def456ghi789

# Meta App
META_APP_ID=670209849105494
META_APP_SECRET=abc123def456ghi789

# Supabase
SUPABASE_URL=https://seu-projeto.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### **2. Configura√ß√£o no Supabase**

```bash
# Via Supabase CLI
supabase secrets set WHATSAPP_ACCESS_TOKEN=EAABwzLixnjYBO...
supabase secrets set WHATSAPP_PHONE_NUMBER_ID=123456789012345
supabase secrets set WHATSAPP_VERIFY_TOKEN=meu_token_verificacao
supabase secrets set INSTAGRAM_CLIENT_SECRET=abc123def456ghi789
supabase secrets set META_APP_SECRET=abc123def456ghi789
```

---

## üß™ **TESTES E VALIDA√á√ÉO**

### **1. Teste WhatsApp Business API**

```bash
# Script de teste
curl -X POST "https://graph.facebook.com/v19.0/PHONE_NUMBER_ID/messages" \
  -H "Authorization: Bearer ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messaging_product": "whatsapp",
    "to": "5511999999999",
    "type": "text",
    "text": {
      "body": "Teste de mensagem"
    }
  }'
```

### **2. Teste Instagram Basic Display**

```bash
# Teste de token
curl -X GET "https://graph.instagram.com/me?fields=id,username&access_token=ACCESS_TOKEN"
```

### **3. Teste de Webhooks**

```bash
# Teste WhatsApp Webhook
curl -X GET "https://connectia.agenciapixel.digital/api/whatsapp-webhook?hub.mode=subscribe&hub.challenge=CHALLENGE&hub.verify_token=VERIFY_TOKEN"

# Teste Instagram Webhook
curl -X POST "https://connectia.agenciapixel.digital/api/instagram-webhook" \
  -H "Content-Type: application/json" \
  -d '{"object": "instagram", "entry": []}'
```

---

## üì§ **PUBLICA√á√ÉO DO APP**

### **1. Prepara√ß√£o para Revis√£o**

#### **A. Documenta√ß√£o Necess√°ria**
- [ ] **Privacy Policy** - Pol√≠tica de privacidade
- [ ] **Terms of Service** - Termos de uso
- [ ] **App Description** - Descri√ß√£o do aplicativo
- [ ] **Screenshots** - Capturas de tela
- [ ] **Demo Video** - V√≠deo demonstrativo

#### **B. Permiss√µes Solicitadas**

```
WhatsApp Business API:
- whatsapp_business_messaging
- whatsapp_business_management

Instagram Basic Display:
- instagram_basic
- pages_show_list
```

### **2. Processo de Revis√£o**

1. **Preencher formul√°rio** de revis√£o
2. **Aguardar an√°lise** (7-14 dias)
3. **Responder questionamentos** se necess√°rio
4. **Aprova√ß√£o** e ativa√ß√£o

### **3. P√≥s-Aprova√ß√£o**

```javascript
// Verificar status do app
const checkAppStatus = async () => {
  const response = await fetch(`https://graph.facebook.com/v19.0/670209849105494?access_token=${ACCESS_TOKEN}`);
  const data = await response.json();
  console.log('App Status:', data);
};
```

---

## üîß **TROUBLESHOOTING**

### **1. Problemas Comuns WhatsApp**

#### **A. Webhook n√£o recebe mensagens**
```bash
# Verificar logs
curl -X GET "https://connectia.agenciapixel.digital/api/whatsapp-webhook?hub.mode=subscribe&hub.challenge=test&hub.verify_token=VERIFY_TOKEN"
```

#### **B. Erro de permiss√£o**
```javascript
// Verificar permiss√µes
const checkPermissions = async () => {
  const response = await fetch(`https://graph.facebook.com/v19.0/me/permissions?access_token=${ACCESS_TOKEN}`);
  const data = await response.json();
  console.log('Permissions:', data);
};
```

#### **C. Token expirado**
```javascript
// Renovar token de longa dura√ß√£o
const refreshToken = async (shortLivedToken) => {
  const response = await fetch(`https://graph.facebook.com/v19.0/oauth/access_token?grant_type=fb_exchange_token&client_id=${APP_ID}&client_secret=${APP_SECRET}&fb_exchange_token=${shortLivedToken}`);
  const data = await response.json();
  return data.access_token;
};
```

### **2. Problemas Instagram**

#### **A. Erro de callback**
```javascript
// Verificar URL de callback
const instagramCallbackUrl = "https://connectia.agenciapixel.digital/auth/instagram/callback";
```

#### **B. Token de acesso expirado**
```javascript
// Renovar token Instagram
const refreshInstagramToken = async (accessToken) => {
  const response = await fetch(`https://graph.instagram.com/refresh_access_token?grant_type=ig_refresh_token&access_token=${accessToken}`);
  const data = await response.json();
  return data.access_token;
};
```

### **3. Logs e Monitoramento**

```typescript
// Fun√ß√£o de log para debug
const logWebhookEvent = (event: any, source: string) => {
  console.log(`[${new Date().toISOString()}] ${source}:`, JSON.stringify(event, null, 2));
  
  // Salvar no Supabase para an√°lise
  supabase
    .from('webhook_logs')
    .insert({
      source,
      event_data: event,
      timestamp: new Date().toISOString()
    });
};
```

---

## üìä **MONITORAMENTO E M√âTRICAS**

### **1. Dashboard de Monitoramento**

```typescript
// Componente de monitoramento
export function MetaMonitoring() {
  const [metrics, setMetrics] = useState({
    whatsappMessages: 0,
    instagramMessages: 0,
    activeChannels: 0,
    errorRate: 0
  });

  useEffect(() => {
    // Buscar m√©tricas do Supabase
    const fetchMetrics = async () => {
      const { data } = await supabase
        .from('channel_metrics')
        .select('*')
        .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());
      
      setMetrics(calculateMetrics(data));
    };

    fetchMetrics();
    const interval = setInterval(fetchMetrics, 60000); // A cada minuto
    
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="grid grid-cols-4 gap-4">
      <MetricCard title="Mensagens WhatsApp" value={metrics.whatsappMessages} />
      <MetricCard title="Mensagens Instagram" value={metrics.instagramMessages} />
      <MetricCard title="Canais Ativos" value={metrics.activeChannels} />
      <MetricCard title="Taxa de Erro" value={`${metrics.errorRate}%`} />
    </div>
  );
}
```

---

## üöÄ **COMANDOS √öTEIS**

### **1. Deploy das Edge Functions**

```bash
# Deploy todas as fun√ß√µes
supabase functions deploy

# Deploy fun√ß√£o espec√≠fica
supabase functions deploy whatsapp-webhook
supabase functions deploy instagram-webhook
supabase functions deploy whatsapp-send-message
```

### **2. Teste Local**

```bash
# Iniciar ambiente local
supabase start

# Testar fun√ß√£o localmente
supabase functions serve whatsapp-webhook --no-verify-jwt
```

### **3. Logs**

```bash
# Ver logs das fun√ß√µes
supabase functions logs whatsapp-webhook
supabase functions logs instagram-webhook
```

---

## üìû **SUPORTE**

### **Contatos T√©cnicos**
- **Email**: contato@agenciapixel.digital
- **Meta Developer Support**: https://developers.facebook.com/support/
- **WhatsApp Business API Support**: https://business.whatsapp.com/support

### **Links √öteis**
- **Meta for Developers**: https://developers.facebook.com/
- **WhatsApp Business API Docs**: https://developers.facebook.com/docs/whatsapp/
- **Instagram Basic Display**: https://developers.facebook.com/docs/instagram-basic-display-api/

---

**üéØ Esta documenta√ß√£o deve ser atualizada conforme novas vers√µes da API Meta s√£o lan√ßadas. √öltima atualiza√ß√£o: Janeiro 2024**
